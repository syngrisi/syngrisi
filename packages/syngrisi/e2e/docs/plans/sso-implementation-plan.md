# План реализации E2E тестов для SSO (SAML и OAuth2) с использованием Logto

Этот план описывает шаги по расширению тестового покрытия SSO, включая поддержку SAML через Logto, проверку негативных сценариев и управление сессиями.

## 1. Подготовка инфраструктуры (Logto)

Необходимо доработать скрипты настройки Logto, чтобы они создавали не только OIDC приложение, но и SAML приложение.

*   **Задача 1.1:** Обновить скрипт `setup-logto.sh` (или создать `setup-logto-saml.sh`).
    *   Добавить создание SAML приложения в Logto через Management API.
    *   Настроить SAML SP (Service Provider) параметры для Syngrisi:
        *   **ACS URL:** `http://localhost:3000/v1/auth/sso/saml/callback`
        *   **Entity ID:** `syngrisi-e2e` (или аналогичный)
    *   Получить и сохранить параметры IdP (Identity Provider) от Logto:
        *   `sso_entry_point` (SAML SSO URL)
        *   `sso_issuer` (Entity ID провайдера)
        *   `sso_cert` (Публичный сертификат для проверки подписи)
    *   Сохранить эти данные в `provisioned-config.json` под ключом `saml`.

## 2. Расширение фикстур и шагов (Playwright)

Нужно научить тесты переключаться между режимами OAuth2 и SAML и конфигурировать сервер соответствующим образом.

*   **Задача 2.1:** Обновить `SSOServerFixture` (`sso-server.fixture.ts`).
    *   Добавить методы для получения SAML-конфигурации из `provisioned-config.json`.
    *   Добавить метод `getSAMLSSOEnvVars()` для генерации переменных окружения:
        *   `SYNGRISI_SSO_PROTOCOL=saml`
        *   `SYNGRISI_SSO_ENTRY_POINT=...`
        *   `SYNGRISI_SSO_ISSUER=...`
        *   `SYNGRISI_SSO_CERT=...`

*   **Задача 2.2:** Обновить шаги в `sso.steps.ts`.
    *   Добавить шаг: `When I configure SAML SSO with auto-provisioned settings`.
    *   Этот шаг должен вызывать фикстуру, получать SAML настройки и прокидывать их в `process.env` перед стартом сервера.

## 3. Новые Feature-файлы

Создадим отдельные файлы для четкого разделения сценариев.

### 3.1. `sso_saml.feature` (Новый файл)

Файл будет зеркальным отражением `sso_logto.feature`, но для SAML.

*   **Background:**
    *   Настройка переменных окружения для SAML (`SYNGRISI_SSO_PROTOCOL=saml`, `SYNGRISI_AUTH=true`).
    *   Старт сервера.
*   **Scenario: Full SAML Login Flow**
    *   Открытие страницы логина.
    *   Клик по кнопке SSO.
    *   Редирект на Logto (SAML flow).
    *   Ввод логина/пароля (интерфейс Logto тот же самый).
    *   Редирект обратно и успешная авторизация.

### 3.2. `sso_common.feature` (Общие сценарии и Edge Cases)

Сценарии, которые не зависят от протокола или проверяют общую логику. Можно запускать на базе OAuth конфигурации (как дефолтной).

*   **Scenario: Login attempt when SSO is disabled**
    *   **Дано:** Сервер запущен с `SYNGRISI_AUTH=true`, но `SSO_ENABLED=false` (или не задан).
    *   **Когда:** Я пытаюсь перейти по прямой ссылке `/v1/auth/sso`.
    *   **То:** Я должен быть перенаправлен на `/auth` с параметром ошибки `error=sso_disabled`.
    *   **И:** Я должен видеть сообщение об ошибке на странице логина (если UI это поддерживает) или просто форму логина.

*   **Scenario: Logout functionality**
    *   **Дано:** Я вошел в систему через SSO (OAuth).
    *   **Когда:** Я нажимаю кнопку "Logout".
    *   **То:** Я должен быть перенаправлен на страницу логина.
    *   **И:** Моя сессия должна быть завершена (попытка открыть защищенную страницу редиректит на логин).
    *   **Важно:** Проверить, что локальная кука сессии удалена.

*   **Scenario: Account Linking (OAuth)**
    *   **Дано:** В базе есть локальный пользователь `testuser@syngrisi.test`.
    *   **Когда:** Я вхожу через SSO с тем же email.
    *   **То:** Я успешно авторизуюсь.
    *   **И:** Тип провайдера пользователя в БД меняется на `oauth` (проверка через API или БД шаг).

*   **Scenario: User Creation (OAuth)**
    *   **Дано:** Пользователя `newuser@syngrisi.test` нет в БД.
    *   **Когда:** Я вхожу через SSO как `newuser`.
    *   **То:** Я успешно авторизуюсь.
    *   **И:** В БД появляется новый пользователь с ролью `user`.

## 4. Реализация и запуск

1.  Реализовать **Задача 1.1** (скрипты Logto).
2.  Реализовать **Задача 2.1** и **2.2** (код тестов).
3.  Создать feature-файлы из **Пункта 3**.
4.  Запустить тесты: `npm run test:e2e -- --grep "@sso"`

## 5. Критерии приемки

*   [ ] Тесты OAuth проходят успешно.
*   [ ] Тесты SAML проходят успешно.
*   [ ] Тест "SSO disabled" проходит (редирект работает корректно).
*   [ ] Тест Logout проходит (сессия уничтожается).
*   [ ] Тесты создания и линковки пользователей проходят.
