# Mega‑промпт: как чинить нестабильные E2E‑тесты Syngrisi

Скопируй и используй блок ниже, когда нужно быстро стабилизировать тесты. Он учитывает вывод из последних 100 коммитов, где чинились флаки и E2E/CI.

```
Ты помогаешь чинить нестабильные Playwright BDD тесты в Syngrisi.

Контекст проекта:
- Тесты лежат в packages/syngrisi/e2e, шаги перегенерируются командой `npx bddgen`.
- Запуск одиночного сценария: `npx bddgen && npx playwright test --project=chromium "features/<path>.feature" --grep "<Scenario>" --workers=1`.
- Локально гоняем полный набор через `npm run test:e2e`, в CI используется `npm run test:e2e:ci` (пропускает @skip-ci, demo, @flaky, @sso*).
- Артефакты: текстовые логи `e2e/test_results.log` и `e2e/test_debug.log`; HTML/трейсы/скриншоты под `reports/` (см. диагностический блок ниже).
- Доп. гайды: `manage-flaky-tests.md` (изоляция флаков), `special-tags.md` (таймауты/ретраи/serial), `testing_strategy.md` (workflow от реда к зелёному), `selector_best_practices.md` (как выбирать локаторы).

Чеклист диагностики:
1) Воспроизведи с `--workers=1` (для локализации конкретного фейла), собери скриншоты.
2) Проверь, что шаги из docs/agent/guides/common_steps_cheatsheet.md уже покрывают кейс — не плодим новые шаги без нужды.
3) Смотри на гонки данных: после Given/When с HTTP/DB действиями убедись, что UI дождался состояния (таблица обновилась, кнопка стала доступной).
4) Отлови, есть ли перекрытия/оверлеи (tooltip, popover, canvas) — это частая причина кликов мимо.
5) Если подход не сработал — откати изменения и попробуй другой (смена локаторов, ожиданий, UI pointer-events, force click). После каждого варианта гоняй стресс: `npx bddgen && npx playwright test --project=chromium "features/<path>.feature" --grep "<Scenario>" --workers=15 --repeat-each=3` и смотри, ушли ли флаки.

Рецепты, подтверждённые последними фикcами:
- Замени «голые ожидания» на семантические проверки. Пример: вместо `wait 10s` используй шаг «жду, пока тест X появится в таблице» с авто‑рефрешем. Проверяй доступность элементов перед кликом: поллинг до enabled для кнопок удаления/регионов, ожидание ready перед highlight.
- Борись с перекрытиями: ставь `pointerEvents: none` на тултипы/обёртки , или кликай через `dispatchEvent('click')` / шаг `I real click` для иконок поповера.
- Учитывай анимации: добавь короткую задержку 200–500 мс перед/после появления модалок и перед кликами, плюс `scrollIntoViewIfNeeded` и `force: true` при необходимости.
- Синхронизируйся с бэкендом: новые шаги «I delete check from modal» ждут API‑ответ, увеличивай таймауты CSS‑проверок до 15s при медленных рендерах.
- Убирай фиксированные sleep'ы в пользу ретраев на сервере (guest login retry в ensureLoggedIn) — если видишь ручные задержки, сначала подумай о ретраях.
- Маркируй заведомо внешние или нестабильные сценарии тэгами `@skip-ci`/`@flaky` и держи тест:e2e полным только локально.
- Если тест горит, но критичен: используй теги/режимы из `special-tags.md` — `@retries:N` для точечного ретрая, `@timeout:XXXX` для долгих действий, `@mode:serial` если нужно последовательное выполнение фичи (Feature‑level).
- Управляй флаками через `manage-flaky-tests.md`: пометь `@flaky`, гоняй отдельным прогоном с 3 воркерами, возвращай в основную матрицу после фикса.

Практические шаги починки:
1) Найди, что именно не стабильно: клики, загрузка данных, состояние кнопки, таймзона/формат даты (при необходимости усиливай проверки формата HH:mm:ss).
2) Улучши локаторы — предпочитай семантику (текст/label/aria-label) вместо «element with locator" (см. `selector_best_practices.md`).
3) Добавь явные ожидания состояния (enabled/visible/не существует), а не задержки.
4) Если клик ловит оверлей — поправь UI (pointer-events) и/или используй шаги `I real click` / `dispatchEvent`.
5) При работе с модалками/поповерами: дождись появления, дай 200–500 мс на анимацию, скролль к цели, кликай с `force: true` только после проверки видимости.
6) Для действий через API (accept/delete) используй готовые шаги: `I accept via http...`, `I delete check from modal` — они ждут ответы.
7) Не забывай про перегенерацию шагов (`npx bddgen`) и сбор артефактов после каждого прогона.

Готовый план фикса:
- Репродуцируй -> поймай артефакты -> уточни локатор/состояние -> добавь ожидания/ретраи -> при необходимости обезвреди оверлеи -> перепроверь на 1 воркере -> опционально пометь @skip-ci, если требуется внешняя инфраструктура.

Диагностика по последнему прогону:
- Общий итог: см. `e2e/test_results.log` (есть полный вывод сборки и раннера) и `e2e/batch-test-results.txt` (батчи: 173 passed, 7 failed, 5 flaky).
- Конкретные падения: `e2e/test_results.log` и `e2e/test_debug.log` фиксируют фейлы в `features/CP/check_details/regions.feature` (несколько сценариев) и `apperance_enabled_buttons.feature` с ошибкой `Stored "js" value "loading" did not become "ready" after 30s` (`steps/common/polling.steps.ts:76`).
- Артефакты для расследования: `reports/test-artifacts/features-CP-check_details--000bf-ed-changes-navigation-alert-chromium*/` — внутри `error-context.md`, `trace.zip` (открыть: `npx playwright show-trace <path>/trace.zip`), `test-failed-1.png`, `browser-console.log`, `backend-logs.txt`.
